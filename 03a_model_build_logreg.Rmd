---
title: "03a_model_build_logreg"
output: html_document
date: "2022-11-19"
---




libraries + setup
```{r}
rm(list=ls())
library(data.table)
library(dplyr)
library(nnet)
library(caret)
library(lubridate)
```

read in data
```{r}
input_date <- "22Dec22"
data <- readRDS(paste0("data/output/final_model_data_multiclass__",input_date,".rds")) %>%
        .[,.(outcome,home2away_delta_rankings,neutral,home2away_delta_goals_scored_last_9_matches
               ,home2away_delta_goals_conceded_last_9_matches,home_fifa_rank_change
               ,home2away_delta_ties_last_9_matches , home2away_delta_wins_last_9_matches
               ,home_fifa_rank_change , away_fifa_rank_change)]

```


```{r}
set.seed(31)

trainIndex <- createDataPartition(data$outcome,p=0.7,list=FALSE,times=1)
test <- data[-trainIndex]
train <- data[trainIndex]
```


```{r}
m1 <- multinom(outcome ~ 
               home2away_delta_rankings+neutral+home2away_delta_goals_scored_last_9_matches
               +home2away_delta_goals_conceded_last_9_matches+home_fifa_rank_change
               +home2away_delta_ties_last_9_matches + home2away_delta_wins_last_9_matches
               +home_fifa_rank_change + away_fifa_rank_change
               ,data=train)
m1 %>% summary()
```

```{r}
z <- summary(m1)$coefficients/summary(m1)$standard.errors
(1-pnorm(abs(z),0,1))*2
```




Example of output:

```{r}
head(round(fitted(m1), 3))
```

accuracy on training data:
```{r}
train$outcomepredicted <- predict(m1,newdata=train,"class")

tab_train <- table(train$outcome, train$outcomepredicted)
tab_train

round((sum(diag(tab))/sum(tab))*100,2)
```

accuracy on testing data:
```{r}
test$outcomepredicted <- predict(m1,newdata=test,"class")

tab_test <- table(test$outcome, test$outcomepredicted)
tab_test

round((sum(diag(tab))/sum(tab))*100,2)
```

discrimination
```{r}
# first we need to predict probabilities

probabilities_test <-predict(m1,newdata=test,type="probs") %>% as.data.table()

#test <- cbind(test,probabilities_test)

#define rest vs. one then ROC
```



## export model object
```{r}
list(n1m,tab_train,tab_test)
saveRDS(paste0("models/logred_",input_date,".rds"))
```

